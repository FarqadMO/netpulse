<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetPulse Dashboard</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>‚ñ∂ NETPULSE<span style="animation: blink 1s infinite">_</span></h1>
            <div class="time-filter">
                <select id="timeRange" onchange="updateGlobalTime()">
                    <option value="1h">Last Hour</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="24h" selected>Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>
            <div class="theme-switcher">
                <button class="theme-btn active" data-theme="hacker" title="Hacker"></button>
                <button class="theme-btn" data-theme="cyberpunk" title="Cyberpunk"></button>
                <button class="theme-btn" data-theme="blood" title="Blood"></button>
                <button class="theme-btn" data-theme="amber" title="Amber"></button>
                <button class="theme-btn" data-theme="ocean" title="Ocean"></button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Overview</button>
            <button class="tab" onclick="showTab('map')">Map</button>
            <button class="tab" onclick="showTab('topology')">Topology</button>
            <button class="tab" onclick="showTab('traces')">Traces</button>
            <button class="tab" onclick="showTab('latency')">Latency</button>
            <button class="tab" onclick="showTab('anomalies')">Anomalies</button>
            <button class="tab" onclick="showTab('hosts')">Hosts</button>
            <button class="tab" onclick="showTab('dns')">DNS</button>
        </div>

        <!-- Overview -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <div class="card-title">IP Status</div>
                    <div class="stat-row"><span class="stat-label">IP</span><span id="stat-ip"
                            class="stat-value">{{.current_ip}}</span></div>
                    <div class="stat-row"><span class="stat-label">ISP</span><span id="stat-isp"
                            class="stat-value">{{.isp}}</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">ASN</span><span id="stat-asn"
                            class="stat-value">{{.asn}}</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">Last Check</span><span id="stat-last-check"
                            class="stat-value">{{.last_check}}</span></div>
                </div>
                <div class="card">
                    <div class="card-title">Statistics</div>
                    <div class="stat-row">
                        <span class="stat-label">Daemon</span>
                        <span id="stat-daemon">{{if .daemon_running}}<span
                                class="status-badge status-running">Online</span>{{else}}<span
                                class="status-badge status-stopped">Offline</span>{{end}}</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">IP Records</span><span id="stat-ip-records"
                            class="stat-value">{{.ip_count}}</span></div>
                    <div class="stat-row"><span class="stat-label">Alive Hosts</span><span id="stat-alive-hosts"
                            class="stat-value">{{.host_count}}</span></div>
                    <div class="stat-row"><span class="stat-label">Open Ports</span><span id="stat-open-ports"
                            class="stat-value">{{.port_count}}</span></div>
                </div>
            </div>
            <div class="card" style="margin-top: 1rem;">
                <div class="card-title">Discovered Hosts</div>
                {{if .hosts}}
                <table>
                    <thead>
                        <tr>
                            <th>IP</th>
                            <th>Hostname</th>
                            <th>Latency</th>
                            <th>Last Seen</th>
                        </tr>
                    </thead>
                    <tbody>{{range .hosts}}<tr>
                            <td>{{.IP}}</td>
                            <td>{{if .Hostname}}{{.Hostname}}{{else}}-{{end}}</td>
                            <td>{{printf "%.1f" .LatencyMs}} ms</td>
                            <td>{{.LastSeen.Format "15:04:05"}}</td>
                        </tr>{{end}}</tbody>
                </table>
                {{else}}<p class="empty-state">> No hosts discovered</p>{{end}}
            </div>
        </div>

        <!-- Map -->
        <div id="map" class="tab-content">
            <div class="card">
                <div class="card-title">GeoIP World Map</div>
                <div class="map-container">
                    <div id="geoMap" class="map-view"></div>
                    <div class="map-panel">
                        <h3>Select Trace</h3>
                        <div id="mapTraceList">
                            <p class="empty-state">> Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topology -->
        <div id="topology" class="tab-content">
            <div class="card">
                <div class="card-title">Network Topology</div>
                <div class="filter-bar">
                    <select id="topologyTarget" onchange="loadTopology()">
                        <option value="">All Targets</option>
                        {{range .trace_targets}}<option value="{{.}}">{{.}}</option>{{end}}
                    </select>
                    <button class="btn" onclick="loadTopology()">Refresh</button>
                </div>
                <div id="topologyDiagram" class="mermaid">graph LR
                    Source[Your Network]
                    Loading[Loading...]
                    Source --> Loading</div>
            </div>
        </div>

        <!-- Traces -->
        <div id="traces" class="tab-content">
            <div class="card">
                <div class="card-title">Traceroute Results</div>
                <div class="filter-bar">
                    <select id="traceFilter" onchange="loadTraces(1)">
                        <option value="">All Targets</option>
                        {{range .trace_targets}}<option value="{{.}}">{{.}}</option>{{end}}
                    </select>
                    <button class="btn" onclick="showCompareMode()" style="margin-left: auto;">Compare Traces</button>
                    <button class="btn" onclick="loadTraces(1)">Refresh</button>
                </div>
                <div id="traceResults">
                    <p class="empty-state">> Loading traces...</p>
                </div>
                <div id="tracePagination" class="pagination"></div>
            </div>
        </div>

        <!-- Trace Comparison Mode (hidden by default) -->
        <div id="traceCompare" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">Compare Traces</div>
                <div class="filter-bar">
                    <label style="margin-right: 10px;">Target IP:</label>
                    <select id="compareTarget" onchange="loadCompareTraceList()">
                        <option value="">Select Target...</option>
                        {{range .trace_targets}}<option value="{{.}}">{{.}}</option>{{end}}
                    </select>
                    <button class="btn" onclick="hideCompareMode()" style="margin-left: auto;">Back to List</button>
                </div>

                <div id="compareSelector" style="display: none; margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label
                                style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 5px;">First
                                Trace</label>
                            <select id="compareTrace1" class="compare-select">
                                <option value="">Select timestamp...</option>
                            </select>
                        </div>
                        <div>
                            <label
                                style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 5px;">Second
                                Trace</label>
                            <select id="compareTrace2" class="compare-select">
                                <option value="">Select timestamp...</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn" onclick="performComparison()" style="width: 100%;">Compare Selected
                        Traces</button>
                </div>

                <div id="compareResults" style="display: none; margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div class="compare-header">
                                <h3 id="compare1Header" style="color: var(--accent); margin-bottom: 5px;">Trace 1</h3>
                                <div id="compare1IP"
                                    style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 10px;"></div>
                            </div>
                            <div id="compare1Content" class="compare-content"></div>
                        </div>
                        <div>
                            <div class="compare-header">
                                <h3 id="compare2Header" style="color: var(--accent); margin-bottom: 5px;">Trace 2</h3>
                                <div id="compare2IP"
                                    style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 10px;"></div>
                            </div>
                            <div id="compare2Content" class="compare-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Latency -->
        <div id="latency" class="tab-content">
            <div class="card">
                <div class="card-title">Latency Trends</div>
                <div class="filter-bar">
                    <select id="latencyTarget" onchange="loadLatencyChart()">
                        <option value="">All Targets</option>
                        {{range .trace_targets}}<option value="{{.}}">{{.}}</option>{{end}}
                    </select>
                </div>
                <canvas id="latencyChart"></canvas>
            </div>
        </div>

        <!-- Anomalies -->
        <div id="anomalies" class="tab-content">
            <div class="card">
                <div class="card-title">Route Changes & Anomalies</div>
                <div id="anomalyList">
                    <p class="empty-state">> Loading anomalies...</p>
                </div>
                <div id="anomalyPagination" class="pagination"></div>
            </div>
        </div>

        <!-- Hosts -->
        <div id="hosts" class="tab-content">
            <div class="card">
                <div class="card-title">Network Security Matrix</div>
                <div class="filter-bar">
                    <input type="text" id="hostFilter" placeholder="Filter by IP..." oninput="filterHosts()">
                </div>
                {{if .hosts}}
                <div class="security-grid" id="hostGrid">
                    {{range .hosts}}
                    <div class="host-card" data-ip="{{.IP}}">
                        <div class="host-header">
                            <div class="host-id">
                                <span class="host-ip">{{.IP}}</span>
                                <span class="host-name">{{if .Hostname}}{{.Hostname}}{{else}}Unknown
                                    Device{{end}}</span>
                            </div>
                            <div class="host-status">
                                <span class="status-dot online"></span>
                                <span class="latency">{{printf "%.0f" .LatencyMs}}ms</span>
                            </div>
                        </div>
                        <div class="port-section">
                            <div class="port-label">OPEN PORTS detected</div>
                            {{if .Ports}}
                            <div class="port-grid">
                                {{range .Ports}}
                                <div class="port-badge" title="{{.Service}}">
                                    <span class="port-num">{{.Port}}</span>
                                    <span class="port-proto">{{.Protocol}}</span>
                                </div>
                                {{end}}
                            </div>
                            {{else}}
                            <div class="no-ports">No open ports found</div>
                            {{end}}
                        </div>
                        <div class="host-footer">
                            <span class="last-seen">Seen: {{.LastSeen.Format "15:04:05"}}</span>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{else}}<p class="empty-state">> No hosts discovered</p>{{end}}
            </div>
        </div>
    </div>

    <!-- DNS -->
    <div id="dns" class="tab-content">
        <div class="card" style="height: 400px; margin-bottom: 20px;">
            <div class="card-title">DNS Latency Monitor (UDP vs DoH)</div>
            <div style="position: relative; height: 100%; width: 100%">
                <canvas id="dnsChart"></canvas>
            </div>
        </div>

        <div class="grid">
            <!-- Integrity Check -->
            <div class="card">
                <div class="card-title">Resolution Integrity</div>
                <table>
                    <thead>
                        <tr>
                            <th>Server</th>
                            <th>UDP IP</th>
                            <th>DoH IP</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dnsIntegrityBody">
                        <tr>
                            <td colspan="4" style="text-align:center">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Target Management -->
            <div class="card">
                <div class="card-title">Custom Monitors</div>
                <div id="targetList" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;"></div>

                <div class="form-group">
                    <input type="text" id="newTargetName" placeholder="Name (e.g. My PiHole)"
                        style="width:100%; margin-bottom:5px">
                    <div style="display:flex; gap:5px">
                        <input type="text" id="newTargetIP" placeholder="UDP IP (192.168.1.5)" style="flex:1">
                        <input type="text" id="newTargetDoH" placeholder="DoH URL (Optional)" style="flex:1">
                    </div>
                    <button onclick="addDNSTarget()" class="btn" style="width:100%; margin-top:10px">Add Target</button>
                </div>
            </div>
        </div>
    </div>

    <div class="actions">
        <a href="/report" class="btn">Download Report</a>
        <button class="btn" onclick="updateActiveTab()">Refresh</button>
    </div>
    <div class="footer">NETPULSE v1.0 | <span class="live-indicator">‚óè</span> Live Poll Mode</div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/dns.js"></script>

    <!-- Asset Modal -->
    <div id="assetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Asset</h3>
                <span class="close" onclick="closeAssetModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="assetId">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="assetName" placeholder="e.g. CEO Laptop">
                </div>
                <div class="form-group">
                    <label>Icon</label>
                    <div class="icon-selector" id="iconSelector">
                        <div class="icon-option" data-icon="desktop" onclick="selectIcon('desktop')">üñ•Ô∏è</div>
                        <div class="icon-option" data-icon="laptop" onclick="selectIcon('laptop')">üíª</div>
                        <div class="icon-option" data-icon="server" onclick="selectIcon('server')">üóÑÔ∏è</div>
                        <div class="icon-option" data-icon="phone" onclick="selectIcon('phone')">üì±</div>
                        <div class="icon-option" data-icon="iot" onclick="selectIcon('iot')">üîå</div>
                        <div class="icon-option" data-icon="printer" onclick="selectIcon('printer')">üñ®Ô∏è</div>
                        <div class="icon-option" data-icon="router" onclick="selectIcon('router')">üåê</div>
                        <div class="icon-option" data-icon="camera" onclick="selectIcon('camera')">üì∑</div>
                    </div>
                    <input type="hidden" id="assetIcon">
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="assetTags" placeholder="Production, Critical, etc.">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background:transparent;border:1px solid #666"
                    onclick="closeAssetModal()">Cancel</button>
                <button class="btn" onclick="saveAssetMetadata()">Save Changes</button>
            </div>
        </div>
    </div>
</body>

</html>